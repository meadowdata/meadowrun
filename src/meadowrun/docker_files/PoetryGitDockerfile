# This is meant to turn pyproject.toml/poetry.lock files into a container. To be used like:
# docker build -t image_name:tag --build-arg PYTHON_IMAGE=python:3.10-slim-bullseye -f src/meadowrun/docker_files/PoetryDockerfile .
# This assumes that ./pyproject.toml and ./poetry.lock exist

# See PoetryDockerfile and PipGitDockerfile for comments

ARG PYTHON_IMAGE

FROM $PYTHON_IMAGE

RUN python -c 'import urllib.request; urllib.request.urlretrieve("https://install.python-poetry.org", "poetry_install.py")' && \
    python poetry_install.py && \
    /root/.local/bin/poetry config virtualenvs.in-project true

RUN apt update && apt install -y git && apt clean && git config --global --add safe.directory '*'

WORKDIR /tmp/
COPY pyproject.toml ./
COPY poetry.lock ./

RUN /root/.local/bin/poetry install --no-root

ENV PATH /tmp/.venv/bin:$PATH
