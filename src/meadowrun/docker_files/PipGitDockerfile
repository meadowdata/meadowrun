# This is meant to turn a pip requirements.txt file into a container. To be used like:
# docker build -t image_name:tag --build-arg ENV_FILE=requirements.txt --build-arg PYTHON_IMAGE=python:3.10-slim-bullseye -f src/meadowrun/docker_files/PipDockerfile .
# This assumes that ./requirements.txt exists and defines the environment

ARG PYTHON_IMAGE

FROM $PYTHON_IMAGE
# - TODO ideally we would host pre-built versions on DockerHub that already have git
#   installed. Alternatively, we could run git on the host and swap out the references
#   to git from the requirements.txt file to point to the local file system
# - TODO This safe.directory setting is a bit of a hack--some code (e.g. the wandb
#   module) calls git (which should be added to additional_software instead of
#   implicitly being included because there's a git-based dependency in the
#   requirements.txt file) in the /meadowrun/code0 directory. Without this setting, that
#   would fail with a "detected dubious ownership in repository" error, even though this
#   isn't actually a git repository
RUN apt update && apt install -y git && apt clean && git config --global --add safe.directory '*'

WORKDIR /tmp/

ARG ENV_FILE

COPY $ENV_FILE ./
RUN python -m pip install -r $ENV_FILE
